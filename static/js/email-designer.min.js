function loadTemplate(e){var t="";return""===e?void loadEditor(t):void $.ajax({cache:!1,dataType:"html",method:"GET",url:e}).done(function(e){t=e,loadEditor(t)}).fail(function(){alert("Failed to load template or snapshot.")})}function loadEditor(e){var t=$("#editor-template-scripts").val();""!==e&&(e=e.replace('<div id="pm-editor-scripts"></div>','<div id="pm-editor-scripts">'+t+"</div>"));var a=document.getElementById("editor-window").contentWindow.document;a.open(),a.write(""),a.write(e),a.close(),""===e?$("#pre-save-changes").attr("disabled","disabled"):$("#pre-save-changes").removeAttr("disabled")}function appendDoctypeToMarkup(e){var t='<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">';return t+e}function getCleanedMarkupString(e,t,a,n){var o=new DOMParser,i=o.parseFromString(e,"text/html"),s=$(i);s.find("#pm-editor-scripts").nextAll().addBack().remove();var l=s.find("#pm-template-doctitle").text()||"";s.find("title").text(l),s.find(".pm-template-editable-paragraph p span").css("line-height","inherit").end().find(".pm-template-editable-paragraph p").find("img").addClass("responsiveimg").attr("style","").end().wrap('<table class="paragraphtable" style="width: 100%;"><tr><td class="paragraphtd" style="width: 100%; font-family: '+n+"; padding: "+t+"; margin: 0; line-height: "+a+';"></td>\n</tr></table>').contents().unwrap(),s.find(".pm-template-editable-container").contents().unwrap(),s.find(".pm-template-editable-container:empty").remove(),s.find("body img").attr("src",function(e,t){return"//"==t.substring(0,2)&&(t=t.replace("//","http://")),"https"==t.substring(0,5)&&(t=t.replace("https","http")),t}),i=s[0];var d=appendDoctypeToMarkup(i.documentElement.outerHTML);return d}function getExistingSnapshots(e,t){var a=$("#load-snapshot-list");a.html(""),$.ajax({cache:!1,data:{extension_groupname:"html",protocol:"//"},dataType:"json",method:"GET",url:e}).done(function(e){e.length>0?(count=0,$.each(e,function(e,n){".snapshot.html"==n.substring(n.length-14)&&($listItem=t.clone(),filename=n.substring(n.lastIndexOf("/")+1),$listItem.find('input[type="radio"]').val(n).end().find(".snapshot-list-item-name").text(filename),a.append($listItem),count++)}),0===count&&a.html("No snapshots found.")):a.html("No snapshots found.")}).fail(function(){a.html("Could not load snapshot list.  Please try again later.")})}function snapshotURLIsValid(e,t){var a=!1;return"undefined"!=typeof t&&t.length&&e.length&&(t=$.trim(t),t=t.replace(/^(https?:)?\/\//,""),e=e.replace(/^http:\/\//,""),t.slice(0,e.length)==e&&".snapshot.html"==t.slice(-14)&&(a=!0)),a}function loadSnapshot(e){var t="",a=$("#load-snapshot-urlfield"),n=$("#load-snapshot-list").find('input[type="radio"]:checked').val(),o=a.val();snapshotURLIsValid(e,n)?t=n:snapshotURLIsValid(e,o)&&(t=o),""!==t?(t=t.replace(/^https?:\/\//,"//"),"//"!==t.slice(0,2)&&(t="//"+t),loadTemplate(t),$("#load-snapshot-modal").modal("hide"),$("#template-select").val("")):alert("Could not load snapshot: snapshot is invalid.")}function getSnapshotMarkup(){var e=$("#editor-window")[0].contentWindow;if(e){e.pmDesignerDestroy();var t=e.document.documentElement.outerHTML;return t=appendDoctypeToMarkup(t),e.pmDesignerEnable(),t}}function getLiveHTMLMarkup(){var e=$("#editor-window")[0].contentWindow;if(e){e.pmDesignerDestroy();var t=e.pmDesignerParagraphPadding(),a=e.pmDesignerParagraphLineHeight(),n=e.pmDesignerParagraphFontFamily(),o=e.document.documentElement.outerHTML,i=getCleanedMarkupString(o,t,a,n);return e.pmDesignerEnable(),i}}function cleanFilename(e){return $.trim(e).replace(/[^a-z0-9-_]/gi,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,100)}function saveSnapshot(e){var t=cleanFilename($("#save-email-name").val()),a=new FormData,n=new FormData,o=getLiveHTMLMarkup(),i=getSnapshotMarkup(),s=new Blob([o],{type:"text/html"}),l=new Blob([i],{type:"text/html"});a.append("file",s,t+".html"),a.append("extension_groupname","html"),a.append("protocol","http://"),n.append("file",l,t+".snapshot.html"),n.append("extension_groupname","html"),n.append("protocol","http://"),$.when($.ajax({cache:!1,contentType:!1,data:a,dataType:"json",method:"POST",processData:!1,url:e}),$.ajax({cache:!1,contentType:!1,data:n,dataType:"json",method:"POST",processData:!1,url:e})).done(function(e,t){var a=e[0].link,n=t[0].link;$("#saved-live-url").text(a),$("#saved-snapshot-url").text(n),$("#save-changes-modal").find(".save-changes-inprogress").addClass("hidden").end().find(".save-changes-success").removeClass("hidden")}).fail(function(){$("#save-changes-modal").find(".save-changes-inprogress").addClass("hidden").end().find(".save-changes-failure").removeClass("hidden")})}function init(e,t,a){var n=$("#template-select"),o=$("#load-snapshot-list").find(".snapshot-wrapper").detach().first(),i="",s="";$(window).on("load",function(){i=n.find("option:selected").text(),s=n.val(),""===s&&(i=n.find("option:nth-child(2)").text(),s=n.find("option:nth-child(2)").val(),n.val(s)),loadTemplate(s,!0)}),n.on("change",function(){var e=$(this).val();window.confirm("Are you sure you want to switch templates? You will lose all changes made in the editor.")?(s=e,i=$(this).find("option:selected").text(),loadTemplate(e,!0)):$(this).val(s)}),$("#load-snapshot-modal").on("show.bs.modal",function(){getExistingSnapshots(e,o)}),$("#load-snapshot").on("click",function(){loadSnapshot(a)}),$("#save-changes").on("click",function(){saveSnapshot(t)})}