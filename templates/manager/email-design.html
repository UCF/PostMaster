{% extends 'base.html' %}
{% block breadcrumbs %}
  {{ block.super }}
  <li><a href="{% url manager-emails %}">Emails</a> <span class="divider">/</span></li>
  <li class="active">
    <a href="{% url manager-email-design %}">Design</a>
  </li>
{% endblock %}

{% block page-body %}
<div class="row">
  <div class="col-md-5 col-sm-5">
    <h2>Email Designer</h2>
  </div>
  <div class="col-md-7 col-sm-7">
    <div class="form-inline pull-right">
      <div class="form-group">
        <select class="form-control" id="template-select">
          <option value="">Select a Template</option>
          {% for template in email_templates %}
            <option value="{{ email_templates_url }}{{ template }}">{{ template }}</option>
          {% endfor %}
        </select>
        <button class="btn btn-default" data-toggle="modal" data-target="#load-snapshot-modal">Load Snapshot</button>
      </div>
    </div>
  </div>
</div>

<noscript>
  <div class="alert alert-danger" role="alert">
    This page requires Javascript to be enabled in order to function properly.  Please enable Javascript on this page and reload.
  </div>
</noscript>

<p>
  Select a template from the dropdown above to start editing.<br>
  Current browser compatibility: Firefox, Chrome, Safari (latest versions).
</p>

<hr>

<!-- The template editor window -->
<div id="editor-window-outer">
  <iframe id="editor-window"></iframe>
</div>

<!-- Form that returns clean markup from the editor -->
<button class="btn btn-lg btn-primary" id="generate-markup" data-toggle="modal" data-target="#generate-markup-modal">
  <span class="glyphicon glyphicon-download"></span> Generate Markup
</button>

<!-- Modal for generating email markup -->
<div class="modal fade" id="generate-markup-modal" role="dialog" tabindex="-1" aria-labelledby="generate-markup-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="generate-markup-modal-label">Get Email Markup</h4>
      </div>
      <div class="modal-body">
        <p>Copy and paste the markup below into a new .html file, then upload the file somewhere that Postmaster can access it via url.</p>
        <p><strong>Make sure to test this markup in Litmus before sending a live email.</strong></p>
        <textarea class="html-textarea" id="generated-markup" autocomplete="off"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for loading a snapshot -->
<div class="modal fade" id="load-snapshot-modal" role="dialog" tabindex="-1" aria-labelledby="load-snapshot-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="load-snapshot-modal-label">Load Snapshot</h4>
      </div>
      <div class="modal-body">
        <p>Select an existing snapshot, or paste a URL into the field below.</p>
        <div id="load-snapshot-list">
          <div class="snapshot-wrapper">
            <label>
              <input type="radio" name="snapshot-list-item" value="">
              <span class="snapshot-list-item-name"></span>
            </label>
          </div>
        </div>
        <div class="form-inline">
          <div class="form-group">
          <label for="load-snapshot-urlfield">Snapshot by URL:</label>
            <input class="form-control" type="text" id="load-snapshot-urlfield" placeholder="Enter a snapshot url here..." />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="load-snapshot" data-dismiss="modal">Load Snapshot</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!--
Contains css, script references necessary for the wysiwyg editor.
These are injected into the email template markup when loadEditor() is called.
-->
<textarea id="editor-template-scripts" class="hidden">
  <link class="pm-editor-script" rel="stylesheet" href="{{ MEDIA_URL }}/fonts/font-awesome-4.3.0/css/font-awesome.min.css" />
  <link class="pm-editor-script" rel="stylesheet" href="{{ MEDIA_URL }}/css/froala_editor.min.css" />
  <link class="pm-editor-script" rel="stylesheet" href="{{ MEDIA_URL }}/css/froala_style.min.css" />
  <link class="pm-editor-script" rel="stylesheet" href="{{ MEDIA_URL }}/css/email-designer-editor.css" />
  <script class="pm-editor-script" src="{{ MEDIA_URL }}/js/jquery-1.11.2.min.js"></script>
  <script class="pm-editor-script" src="{{ MEDIA_URL }}/js/froala.min.js"></script>
  <script class="pm-editor-script" src="{{ MEDIA_URL }}/js/froala-font_size.min.js"></script>
  <script class="pm-editor-script" src="{{ MEDIA_URL }}/js/froala-media_manager.min.js"></script>
  <script class="pm-editor-script" src="{{ MEDIA_URL }}/js/email-designer-editor.js"></script>
  <script>
    $.Editable.DEFAULTS.key = '{{ froala_license }}';
    var fileUploadURL = '{% url manager-file-upload %}',
        fileGetURL = '{% url manager-files-get %}',
        fileDeleteURL = '{% url manager-file-delete %}',
        imgExtensionGroupname = '{{ valid_image_groupname }}';

    pmDesignerInit(fileUploadURL, fileGetURL, fileDeleteURL, imgExtensionGroupname);
  </script>
</textarea>

{% endblock %}

{% block javascript-footer %}
  {{ block.super }}
  <script src="{{ MEDIA_URL }}/js/email-designer.js"></script>
  <script>
    // TODO cleanup
    var getSnapshotsURL = '{% url manager-files-get %}';

    init(getSnapshotsURL);
  </script>
{% endblock %}
